{% extends 'matching/base.html' %}

{% load static %}
{% block style %}
  <link rel="stylesheet" type="text/css" href="{% static 'matching/chat.css' %}">
{% endblock %}

{% block content %}

<div id="post-top">
{% if user.pk == post.user.pk and post.finding_match == True %}
  <a href="{% url 'matching:close_post' post.pk %}"><button id="mybutton" type="submit">모집 종료</button></a>
{% endif %}

{% if post.tutor is null and user != post.user %}
  <form action="{% url 'matching:set_tutor' postpk=post.pk userpk=user.pk  %}"  method="POST">
    {% csrf_token %}
    <button id="mybutton" type="submit">튜터링 시작</button>
  </form>
{% endif %}
</div>
<hr style="border-top:2px solid #bbb;">



<div class="chat">
  <div class="title">
    {{ post.title }}
  </div>

  <div class="mesgs">
    <div id="msg_history" class="msg_history">

      {% for comment in comment_list %}
      {% if comment.user.pk == user.pk %}
      <div class="outgoing_msg">
        <div class="sent_msg">
          <p>{{ comment.content }}</p>
          <span class="sent_time_date"> {{ comment.pub_date|date:"P"}}    |  {{ comment.pub_date|date:"m.d"}} </span> 
        </div>
      </div>
      {% else %}
      <div class="incoming_msg">
        <!--<div class="incoming_msg_img"> <img src="" alt=""> </div>-->
        <div class="received_msg">
          <div class="received_with_msg">
            <p>{{ comment.content }}</p>
            <span class="received_time_date"> {{ comment.pub_date|date:"P"}}   | {{ comment.pub_date|date:"m.d"}} </span>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}

    </div>
    <div class="type_msg">
      <div class="input_msg_write">
        <input type="text" id="write_msg" class="write_msg" placeholder="Type a message" />
        <button id="msg_send_btn" class="msg_send_btn" type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
      </div>
    </div>
  </div>
</div>

  <script>
    console.log(document.getElementById("msg_send_btn"));
    document.getElementById("msg_send_btn").addEventListener("click", sendMessage);

    const websocket = new WebSocket('ws://' + window.location.host + '/ws/post/' + "{{post.pk}}" + '/');
    
    websocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    var req_username = "{{request.user.username}}";
    
    // Set table structure
    var storage = document.getElementById("msg_history");
    console.log(data);
    
    if(data['username']==req_username){
      console.log("outgoing");
      console.log(storage);
      var msg = document.createElement("div");
      msg.className = "outgoing_msg";
      var inner_msg = document.createElement("div");
      inner_msg.className = "sent_msg";
      var msg_content = document.createElement("p");
      msg_content.innerHTML += data['content'];
      var msg_time = document.createElement("span");
      msg_time.className = "sent_time_date";
      msg_time.innerHTML += data['date'];
      inner_msg.append(msg_content);
      inner_msg.append(msg_time);
      msg.append(inner_msg);
      storage.append(msg);
    }else{
      console.log("incoming");
      var msg = document.createElement("div");
      msg.className = "incoming_msg";
      var inner_msg = document.createElement("div");
      inner_msg.className = "received_msg";
      var inner_inner_msg = document.createElement("div");
      inner_inner_msg.className = "received_with_msg";
      var msg_content = document.createElement("p");
      msg_content.innerHTML += data['content'];
      var msg_time = document.createElement("span");
      msg_time.className = "received_time_date";
      msg_time.innerHTML += data['date'];
      inner_inner_msg.append(msg_content);
      inner_inner_msg.append(msg_time);
      inner_msg.append(inner_inner_msg);
      msg.append(inner_msg);
      storage.append(msg);
    }
    };
    
    websocket.onclose = function(e){
    console.error('Chat socket closed unexpectedly');
    };

    function sendMessage(){
      console.log("send message");
      event.preventDefault();

      $.ajax({
         url: "{% url 'matching:send_message' %}",
         type: "GET",
         data:{
           postid: {{post.id}},
           content: $("#write_msg").val(),
         },
         success: function(response){
           //console.log(data)
            //alert("SUCCESS\n" + response);
            
            websocket.send(JSON.stringify({
               'postId': response,
            }));
            $("#classCreateName").value = "";
         },
         error: function(response){
            //alert("ERROR!!\n" + response);
         }
      });

    }
    
    </script>

{% endblock %}
