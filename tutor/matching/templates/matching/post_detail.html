{% extends 'matching/base.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" type="text/css" href="{% static 'matching/chat.css' %}">
{% endblock %}

{% block content %}
<div id="post-top">

{% if user == post.user and post.finding_match == True %}
  <form action="{% url 'matching:close_post' post.pk %}"  method="POST">
    {% csrf_token %}
    <button id="mybutton" type="submit">모집 종료</button>
  </form>
{% endif %}


{% if post.tutor is null and user != post.user %}
  <form action="{% url 'matching:set_tutor' postpk=post.pk userpk=user.pk  %}"  method="POST">
    {% csrf_token %}
    <button id="mybutton" type="submit">튜터링 시작</button>
  </form>
{% endif %}
</div>
<hr style="border-top:2px solid #bbb;">



<div class="chat">
  <div class="title">
    {{ post.title }}
    {{ post.update_hit }}
  </div>

  <div class="mesgs">
    <div id="msg_history" class="msg_history">
      <script>

      </script>
      {% for comment in comment_list %}
        {% if comment.user != user %}
        <div class="date">
          <script type="text/javascript">
            var cur_date = "{{comment.pub_date|date:'Y.m.d'}}" ;
            date_line(cur_date) ;
          </script>
        </div>
        <div class="incoming_msg">
          <!--<div class="incoming_msg_img"> <img src="" alt=""> </div>-->
          <div class="received_msg">
            <p class="received_name">{{comment.user.profile.nickname}}</p>
            <div class="received_with_msg">
              {{ comment.content }}

            </div>
            <span class="received_time_date">{{ comment.pub_date|date:"P"}} </span>
          </div>
        </div>
        {% else %}
          <div class="date">
            <script type="text/javascript">
              var cur_date = "{{comment.pub_date|date:'Y.m.d'}}" ;
              date_line(cur_date) ;
            </script>
          </div>
          <div class="outgoing_msg">
            <div class="sent_msg">
              <span class="sent_time_date"> {{ comment.pub_date|date:"P"}}</span>
              <div id="msg_box">{{ comment.content }}</div>
            </div>
          </div>
        {% endif %}
      {% endfor %}

    </div>
    <div class="type_msg">
      <div class="input_msg_write">
        <input type="text" id="write_msg" class="write_msg" placeholder="Type a message" />
        <button id="msg_send_btn" class="msg_send_btn" type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
      </div>
    </div>
  </div>
</div>

  <script>
    document.getElementById("msg_send_btn").addEventListener("click", sendMessage);
    var message = document.getElementById("write_msg");
    message.focus();
    message.addEventListener("keyup", function(event){
      if(event.keyCode == 13){
        event.preventDefault();
        if(message.value.trim()!=''){
          document.getElementById("msg_send_btn").click();
        }
      }
    })

    var storage = document.getElementById("msg_history");
    storage.scrollTop = storage.scrollHeight;

    const websocket = new WebSocket('ws://' + window.location.host + '/ws/post/' + "{{post.pk}}" + '/');

    websocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    var req_username = "{{request.user.username}}";

    // Set table structure
    /*var storage = document.getElementById("msg_history");
    alert(storage.scrollHeight);
    storage.scrollTop = storage.scrollHeight;*/
    var at_bottom = false;
    if(storage.scrollTop == storage.scrollHeight - storage.offsetHeight){
      at_bottom = true;
    }

    if(data['username']==req_username){
      //console.log("outgoing");

      var msg = document.createElement("div");
      msg.className = "outgoing_msg";
      var inner_msg = document.createElement("div");
      inner_msg.className = "sent_msg";
      var msg_time = document.createElement("span");
      msg_time.className = "sent_time_date";
      msg_time.innerHTML += data['date'];
      var msg_content = document.createElement("div");
      msg_content.id = "msg_box";
      msg_content.innerHTML += data['content'];
      msg_time.append(msg_content);
      inner_msg.append(msg_time);
      msg.append(inner_msg);
      storage.append(msg);

    }else{
      //console.log("incoming");
      var incoming_msg = document.createElement("div");
      incoming_msg.className = "incoming_msg";
      var received_msg = document.createElement("div");
      received_msg.className = "received_msg";
      var received_name = document.createElement("p");
      received_name.className = "received_name";
      received_name.innerHTML += data['nickname'];
      var received_with_msg = document.createElement("div");
      received_with_msg.className = "received_with_msg";
      received_with_msg.innerHTML += data['content'];
      var received_time_date = document.createElement("span");
      received_time_date.className = "received_time_date";
      received_time_date.innerHTML += data['date'];
      received_msg.append(received_name);
      received_msg.append(received_with_msg);
      received_msg.append(received_time_date);
      incoming_msg.append(received_msg);
      storage.append(incoming_msg);
    }

    if(at_bottom){
      storage.scrollTop = storage.scrollHeight;
    }


    };

    websocket.onclose = function(e){
    console.error('Chat socket closed unexpectedly');
    };

    function sendMessage(){
      event.preventDefault();

      $.ajax({
         url: "{% url 'matching:send_message' %}",
         type: "GET",
         data:{
           postid: {{post.id}},
           content: $("#write_msg").val(),
         },
         success: function(response){
           //console.log(data)
            //alert("SUCCESS\n" + response);

            websocket.send(JSON.stringify({
               'postId': response,
            }));
            message.value = "";
         },
         error: function(response){
            //alert("ERROR!!\n" + response);
         }
      });

    }

    </script>

{% endblock %}
