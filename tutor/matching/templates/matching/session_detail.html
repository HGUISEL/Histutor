{% extends 'matching/base.html' %}
{% load static %}
{% block style %}
  <link rel="stylesheet" type="text/css" href="{% static 'matching/chat.css' %}">
{% endblock %}


{% block content %}
<script>
  let cur_date ;
  const date_line = (cur) => {
    if(date_line.date === undefined){
    date_line.date=cur;
    document.write("___________ " + date_line.date + " ___________"  ) ;
    }
    else if(date_line.date !== cur_date){
    date_line.date = cur;
    document.write("___________ " + date_line.date + " ___________"  ) ;
    }
  }
</script>

<div class="update_tutee">
  <form action="{% url 'matching:session_detail' session.pk %}" method="POST">
    {% csrf_token %}
    <button class="mybutton" type="submit">새로운 튜터링 시작</button>
  </form>
</div>
<div id="buttonDiv">
  <table class="table">
      <tbody>
        {% if session.tutor %}
        <tr>
          <td class="text-center text-nowrap align-middle"><b>튜터</b></td>
          <td class="text-center text-nowrap align-middle">{{ session.tutor.profile.nickname }}</td>
        </tr>
        {% endif %}
        <tr>
          <td class="text-center text-nowrap align-middle"><b>세션유형</b></td>
          <td class="text-center text-nowrap align-middle">{{session.get_session_type_display}}</td>
        </tr>
        <tr>
          <td class="text-center text-nowrap align-middle"><b>세션 상태</b></td>
          <td class="text-center text-nowrap align-middle">
            {% if today < session.start_time %}
            <p style="color:#0c6b27; margin:4px; margin-bottom:10px;"><b> 진행 예정</b></p>
            {% elif session.fin_time is NULL %}
            <p style="color:#4858b7; margin:4px; margin-bottom:10px;"><b> 진행중 </b></p>
            {% elif user == post.tutor and not my_report %}
            <p style="color:#e43331; margin:4px; margin-bottom:10px;"><b> 보고서 미작성 </b></p>
            {% else %}
            <p style="color:#bbb; margin:4px; margin-bottom:10px;"><b> 종료 </b></p>
            {% endif %}
          </td>
        </tr>
        <tr>
          <td class="text-center text-nowrap align-middle"><b>장소</b></td>
          <td class="text-center text-nowrap align-middle">{{session.location}}</td>
        </tr>
        <tr>
          <td class="text-center text-nowrap align-middle"><b>시작 시간</b></td>
          <td class="text-center text-nowrap align-middle">
            {% if session.start_time|date:'Y-m-d' == today|date:'Y-m-d' %}
            {{session.start_time|date:'H:i'}}
            {% else %}
            {{session.start_time|date:'Y-m-d H:i'}}
            {% endif %}
          </td>
        </tr>
        {% if session.fin_time %}
        <tr>
          <td class="text-center text-nowrap align-middle"><b>종료 시간</b></td>
          <td class="text-center text-nowrap align-middle">
            {% if session.fin_time|date:'Y-m-d' == today|date:'Y-m-d' %}
            {{session.fin_time|date:'H:i'}}
            {% else %}
            {{session.fin_time|date:'Y-m-d H:i'}}
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td class="text-center text-nowrap align-middle"><b>종료 예정 시간</b></td>
          <td class="text-center text-nowrap align-middle">
            {% if session.expected_fin_time|date:'Y-m-d' == today|date:'Y-m-d' %}
            {{session.expected_fin_time|date:'H:i'}}
            {% else %}
            {{session.expected_fin_time|date:'Y-m-d H:i'}}
            {% endif %}
          </td>
        </tr>
        {% endif %}
      </tbody>
  </table>

  {% if session.tutor and not session.fin_time %}
  <button class="mybutton" type="submit"  data-toggle="modal" data-target="#endSession">튜터 세션 종료</button>

  <div class="modal fade" id="endSession" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">튜터 세션 종료</h4>
        </div>
        <div class="modal-body">
          <p>정말로 진행중인 튜터세션을 종료하시겠습니까?</p>
          <div class="row" style="float: right;">
              <div class="col-12-xs text-center" style="margin-right: 1em;">
                  <button class="btn btn-md" style="border: 2px solid #6C639C; border-radius: 15px;" type="button" class="close" data-dismiss="modal">No</button>
                  <button class="btn btn-md" style="border: 2px solid #6C639C; border-radius: 15px;" onclick="location.href='{% url "matching:end_session" session.pk %}'">Yes</button>
              </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  {% endif %}

  <!-- 
    {% if report_exist %}
    <button class="mybutton" type="button"  data-toggle="modal" data-target="#reportModal" style="float:left">보고서 쓰기</button>
    {% endif %}

    {% if post.tutor is null and user.profile.is_tutor and post.finding_match %}
    <button class="mybutton" type="submit" onclick="location.href='{% url "matching:set_tutor" postpk=post.pk userpk=user.pk  %}'">튜터링 시작</button>
    {% endif %}
    {% if post.start_time and not post.fin_time and user == post.tutor %}
    <button class="mybutton" type="submit"  data-toggle="modal" data-target="#cancelTutoringModal">튜터링 취소</button>
    <button class="mybutton" type="submit"  data-toggle="modal" data-target="#finishTutoringModal">튜터링 완료</button>

    <div class="modal fade" id="cancelTutoringModal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">튜터링 취소</h4>
          </div>
          <div class="modal-body">
            <p>정말로 진행중인 튜터링을 취소하시겠습니까?</p>
            <div class="row" style="float: right;">
                <div class="col-12-xs text-center" style="margin-right: 1em;">
                    <button class="btn btn-md" style="border: 2px solid #6C639C; border-radius: 15px;" type="button" class="close" data-dismiss="modal">No</button>
                    <button class="btn btn-md" style="border: 2px solid #6C639C; border-radius: 15px;" onclick="location.href='{% url "matching:cancel_tutoring" post.pk %}'">Yes</button>
                </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="modal fade" id="finishTutoringModal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">튜터링 완료</h4>
          </div>
          <div class="modal-body">
            <p>튜터링을 완료하시겠습니까?</p>
            <div class="row" style="float: right;">
                <div class="col-12-xs text-center" style="margin-right: 1em;">
                    <button class="btn btn-md" style="border: 2px solid #6C639C; border-radius: 15px;" type="button" class="close" data-dismiss="modal">No</button>
                    <button class="btn btn-md" style="border: 2px solid #6C639C; border-radius: 15px;" onclick="location.href='{% url "matching:fin_tutoring" post.pk %}'">Yes</button>
                </div>
            </div>
          </div>

        </div>
      </div>
    </div>
    {% endif %}

    {% if post.report %}
    {% if user == post.user or user.is_staff %}
    <button class="mybutton" type="submit" onclick="location.href='{% url "matching:report_detail" post.report.pk %}'">보고서 보기</button>
    {% endif %}
    {% endif %}-->
</div>




<div class="chat">
  <div class="title">
    {{ session.title }}
  </div>

  <div class="mesgs">
    <div id="msg_history" class="msg_history">
      {% for comment in comment_list %}
        {% if comment.content == start_msg %}
        <div class="start_tutoring">
          &nbsp;&nbsp;튜터링 시작&nbsp;&nbsp;
        </div>
        {% elif comment.content == cancel_msg %}
        <div class="cancel_tutoring">
          &nbsp;&nbsp;튜터링 취소&nbsp;&nbsp;
        </div>
        {% elif comment.user != user %}
        <div class="date">
          <script>
            cur_date = "{{comment.pub_date|date:'Y.m.d'}}" ;
            date_line(cur_date) ;
          </script>
        </div>
        <div class="incoming_msg">
          <div class="received_msg">
            <p class="received_name">{{comment.user.profile.nickname}}</p>
            <div id="comment{{ forloop.counter0 }}" class="received_with_msg msg_content">
              {{ comment.content }}
            </div>
            <span class="received_time_date">{{ comment.pub_date|date:"P"}} </span>
          </div>
        </div>
        {% else %}
          <div class="date">
            <script type="text/javascript">
              cur_date = "{{comment.pub_date|date:'Y.m.d'}}" ;
              date_line(cur_date) ;
            </script>
          </div>
          <div class="outgoing_msg">
            <div class="sent_msg">
              <span class="sent_time_date"> {{ comment.pub_date|date:"P"}}</span>
              <div id="comment{{ forloop.counter0 }}" class="msg_content msg_box">{{ comment.content }}</div>
            </div>
          </div>
        {% endif %}
      {% endfor %}


    </div>
    <div class="type_msg">
      <div class="input_msg_write">
        <input type="text" id="write_msg" class="write_msg" placeholder="Type a message" />
        <button id="msg_send_btn" class="msg_send_btn" type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
      </div>

    </div>
  </div>
</div>

<!--
{% if report_exist %}
    <div id="reportModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <form action="{% url 'matching:tutee_report' report_post_pk %}" method="POST">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">보고서쓰기</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            {% csrf_token %}
            <p>튜터링 시간 : {{report_form.duration_time}} 분</p>
            {% if report_form.join_tutee %}
            <p>튜터링에 참여한 튜티 정보를 입력해주세요.</p>
            {{report_form.join_tutee}}
            <br>
            {% endif %}
            <p>튜터링 내용 등을 간단히 적어주세요 <br />(튜터링 보고서는 운영자 및 담당 교수만 확인할 수 있습니다.)</p>
            {{report_form.content}}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-default">Submit</button>
          </div>
        </div>
        </form>

      </div>
    </div>
{% endif %}-->

<script>

  const makeUrl = function(text){
    var urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
      return '<a class="urls" href="' + url + '">' + url + '</a>';
    })
  }

  window.onload = function(){
    let msgContents = document.querySelectorAll(".msg_content");
    msgContents.forEach(function(msg){
      document.getElementById(`${msg.id}`).innerHTML = makeUrl(msg.textContent);
    });
  }

  document.getElementById("msg_send_btn").addEventListener("click", function(event){
    var msg = document.getElementById("write_msg");
    if(msg.value.trim()!=''){
      sendMessage();
    }
  })

  var message = document.getElementById("write_msg");
  message.focus();
  message.addEventListener("keyup", function(event){
    if(event.keyCode == 13){
      event.preventDefault();
        document.getElementById("msg_send_btn").click();
    }
  })

  var storage = document.getElementById("msg_history");
  storage.scrollTop = storage.scrollHeight;

  const websocket = new WebSocket('ws://' + window.location.host + '/ws/post/' + "{{post.pk}}" + '/');

  websocket.onmessage = function(e) {
  const data = JSON.parse(e.data);
  var req_username = "{{request.user.username}}";

  // Set table structure
  /*var storage = document.getElementById("msg_history");
  alert(storage.scrollHeight);
  storage.scrollTop = storage.scrollHeight;*/
  var at_bottom = false;
  if(storage.scrollTop == storage.scrollHeight - storage.offsetHeight){
    at_bottom = true;
  }
  if(data['type'] == "star_comment"){
    var msg = document.createElement("div");
    msg.className = "start_tutoring";
    msg.innerHTML = "✨&nbsp;&nbsp;튜터링 시작&nbsp;&nbsp;✨";
    storage.append(msg);
  }
  else if(data['username']==req_username){
    //console.log("outgoing");

    var msg = document.createElement("div");
    msg.className = "outgoing_msg";
    var inner_msg = document.createElement("div");
    inner_msg.className = "sent_msg";
    var msg_time = document.createElement("span");
    msg_time.className = "sent_time_date";
    msg_time.innerHTML += data['date'];
    var msg_content = document.createElement("div");
    msg_content.className = "msg_box";
    msg_content.innerHTML += makeUrl(data['content']);
    inner_msg.append(msg_time);
    inner_msg.append(msg_content);
    msg.append(inner_msg);
    storage.append(msg);

  }else{
    //console.log("incoming");
    var incoming_msg = document.createElement("div");
    incoming_msg.className = "incoming_msg";
    var received_msg = document.createElement("div");
    received_msg.className = "received_msg";
    var received_name = document.createElement("p");
    received_name.className = "received_name";
    received_name.innerHTML += data['nickname'];
    var received_with_msg = document.createElement("div");
    received_with_msg.className = "received_with_msg";
    received_with_msg.innerHTML += makeUrl(data['content']);
    var received_time_date = document.createElement("span");
    received_time_date.className = "received_time_date";
    received_time_date.innerHTML += data['date'];
    received_msg.append(received_name);
    received_msg.append(received_with_msg);
    received_msg.append(received_time_date);
    incoming_msg.append(received_msg);
    storage.append(incoming_msg);
  }

  if(at_bottom){
    storage.scrollTop = storage.scrollHeight;
  }


  };

  websocket.onclose = function(e){
  console.error('Chat socket closed unexpectedly');
  };

  function sendMessage(){
    event.preventDefault();

    $.ajax({
       url: "{% url 'matching:send_message' %}",
       type: "GET",
       data:{
         postid: {{post.id}},
         content: $("#write_msg").val(),
       },
       success: function(response){
         //console.log(data)
          //alert("SUCCESS\n" + response);

          websocket.send(JSON.stringify({
             'postId': response,
          }));
          message.value = "";
       },
       error: function(response){
          //alert("ERROR!!\n" + response);
       }
    });

  }
</script>

{% endblock %}
